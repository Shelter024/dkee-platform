name: Disaster Recovery Drill

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 1 */3 *' # 03:00 UTC, first day every 3rd month

jobs:
  restore-test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        ports: [ '5433:5432' ]
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: dkee_restore
        options: >-
          --health-cmd="pg_isready -U postgres" --health-interval=10s --health-timeout=5s --health-retries=5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install AWS CLI (if using S3)
        if: env.BACKUP_PROVIDER == 's3'
        run: sudo apt-get update && sudo apt-get install -y awscli

      - name: Setup Env
        run: |
          echo "BACKUP_PROVIDER=${{ secrets.BACKUP_PROVIDER }}" >> $GITHUB_ENV
          echo "S3_BUCKET=${{ secrets.S3_BUCKET }}" >> $GITHUB_ENV
          echo "BACKUP_ENCRYPTION_KEY=${{ secrets.BACKUP_ENCRYPTION_KEY }}" >> $GITHUB_ENV

      - name: Configure AWS
        if: env.BACKUP_PROVIDER == 's3'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Fetch Latest Backup (S3)
        if: env.BACKUP_PROVIDER == 's3'
        run: |
          LATEST=$(aws s3 ls s3://$S3_BUCKET/db-backups/ | awk '{print $4}' | sort | tail -1)
          if [ -z "$LATEST" ]; then echo "No backups found" && exit 1; fi
          aws s3 cp "s3://$S3_BUCKET/db-backups/$LATEST" backup.enc_or_gz
          if aws s3 ls "s3://$S3_BUCKET/db-backups/$LATEST.sha256"; then aws s3 cp "s3://$S3_BUCKET/db-backups/$LATEST.sha256" backup.sha256; fi
          ls -lh
        
      - name: Use Artifact (Fallback)
        if: env.BACKUP_PROVIDER != 's3'
        run: echo "Artifact restore path not implemented; ensure S3 provider configured." && exit 1

      - name: Verify & Decrypt
        run: |
          if [ -f backup.sha256 ]; then sha256sum -c backup.sha256; fi
          FILE=backup.enc_or_gz
          if [[ "$FILE" == *.enc ]]; then openssl enc -d -aes-256-cbc -pbkdf2 -in "$FILE" -out backup.dump.gz -pass pass:"$BACKUP_ENCRYPTION_KEY"; else cp "$FILE" backup.dump.gz; fi
          gunzip backup.dump.gz
          ls -lh

      - name: Restore
        env:
          PGPASSWORD: postgres
        run: |
          pg_restore -h localhost -p 5433 -U postgres -d dkee_restore -c backup.dump || (echo "Restore failed" && exit 1)

      - name: Post-Restore Verification
        env:
          PGPASSWORD: postgres
        run: |
          psql -h localhost -p 5433 -U postgres -d dkee_restore -c "\dt" | grep -q "exportlog" || (echo "Expected table not found" && exit 1)
          psql -h localhost -p 5433 -U postgres -d dkee_restore -c "SELECT COUNT(*) FROM exportlog;"

      - name: Success Marker
        run: echo "DR drill completed successfully"